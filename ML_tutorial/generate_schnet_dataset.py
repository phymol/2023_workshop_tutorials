import os
import numpy as np
from ase import Atoms
import schnetpack as spk
from schnetpack.data import ASEAtomsData
import schnetpack.transform as trn

# download
# http://quantum-machine.org/gdml/data/npz/md17_ethanol.npz
data = np.load('./md17_ethanol.npz')
# this is a dictionary of configurations of ethanol using DFT (PBE+vdW-TS)
# generated by molecular dynamics trajectories at 500 K,
# with a resolution of 0.5 fs
num_samples = 10000 # only use the first 10000 snapshots of the database


numbers = data["z"]
input_list = []
property_list = []
for i,(positions, energies, forces) in enumerate(zip(data["R"], data["E"],
                                                     data["F"])):
    if i == num_samples:
        break
    mol_geo = Atoms(positions=positions, numbers=numbers)
    properties = {'energy': energies, 'forces': forces}
    input_list.append(mol_geo)
    property_list.append(properties)
                                          

if os.path.exists('./ethanol_dataset.db'):
    print("Database already exits")
else:   
    # create the database file
    ethanol_dataset = ASEAtomsData.create(
        './ethanol_dataset.db', 
        distance_unit='Ang',
        property_unit_dict={'energy':'kcal/mol', 'forces':'kcal/mol/Ang'}
    )    
    # store samples of different configurations of R, Z, E, and F
    ethanol_dataset.add_systems(property_list, input_list)
    print("Successfully generated database")

ethanol_data = spk.data.AtomsDataModule(
    './ethanol_dataset.db', 
    batch_size=10,
    distance_unit='Ang',
    property_units={'energy':'kcal/mol', 'forces':'kcal/mol/Ang'},
    num_train=100,
    num_val=100,
    transforms=[
        trn.ASENeighborList(cutoff=5.),
        trn.RemoveOffsets("energy", remove_mean=True, remove_atomrefs=False),
        trn.CastTo32()
    ],
    num_workers=0, #set to 0 so that this runs on Windows OS
    pin_memory=False, # set to false, when not using a GPU
)
ethanol_data.prepare_data()
ethanol_data.setup()

